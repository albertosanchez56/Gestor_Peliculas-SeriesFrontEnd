<main *ngIf="movie as mv; else loadingTpl">
  <!-- HERO -->
  <section class="backdrop-hero">
    <img class="backdrop-img" [src]="backdropSrc(movie)" [srcset]="backdropSrcset(movie)" sizes="100vw"
      [alt]="'Fondo de ' + (movie?.title || '')" />

    <div class="backdrop-fade"></div>

    <div class="hero-content">
      <div class="hero-poster">
        <img [src]="mv.posterUrl || 'assets/imagenes/placeholder-poster.png'" [alt]="'Póster de ' + mv.title" />
        <button class="favorite-button" (click)="onToggleFavorite()">+</button>
      </div>

      <div class="hero-trailer" *ngIf="trailerEmbed; else noTrailerTpl">
        <div class="video-frame">
          <iframe [src]="trailerEmbed" title="Trailer" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      </div>

      <ng-template #noTrailerTpl>
        <div class="hero-trailer no-trailer">
          <p>No hay tráiler disponible.</p>
        </div>
      </ng-template>
    </div>
  </section>

  <!-- DETAILS -->
  <div class="movie-details-container">
    <header class="movie-header">
      <h1 class="movie-title">{{ mv.title }}</h1>
      <span class="movie-rating">{{ ratingText }}</span>
    </header>

    <div class="movie-info-block">
      <p *ngIf="mv.genres?.length"><strong>Género:</strong> {{ genreList }}</p>
      <hr *ngIf="mv.genres?.length" />

      <p><strong>Sinopsis:</strong> {{ mv.description || 'No disponible.' }}</p>
      <hr />

      <p *ngIf="mv?.director?.name as dName">
        <strong>Director:</strong> {{ dName }}
      </p>
      <hr />
    </div>

    <!-- CAST -->
    <section *ngIf="cast.length" class="cast-section">
      <h2 class="cast-title">Reparto principal</h2>

      <div class="cast-grid">
        <div class="cast-card" *ngFor="let c of visibleCast">
          <div class="cast-thumb">
            <img [src]="c.profileUrl || 'assets/imagenes/placeholder-profile.png'" [alt]="c.personName" />
          </div>
          <div class="cast-meta">
            <div class="cast-name">{{ c.personName }}</div>
            <div class="cast-role" *ngIf="c.characterName">{{ c.characterName }}</div>
          </div>
        </div>
      </div>

      <div class="cast-toggle">
        <button class="toggle-btn" (click)="toggleCast()">
          {{ showAllCast ? 'Ver menos' : 'Ver todo el reparto' }}
        </button>
      </div>
    </section>

    <hr />

    <!-- REVIEWS -->
    <section class="user-reviews">
      <h2>Opiniones de Usuarios</h2>

      <!-- Scores -->
      <div class="ratings-row">
        <div class="rating-chip">
          <strong>TMDB:</strong> {{ ratingText }}
        </div>

        <div class="rating-chip">
          <strong>Usuarios:</strong>
          <ng-container *ngIf="statsData as st; else noStats">
            {{ st.averageUserRating !== null ? (st.averageUserRating | number:'1.1-1') : '—' }}/10
            ({{ st.voteCount }} opiniones)

          </ng-container>
          <ng-template #noStats>—</ng-template>
        </div>
      </div>

      <!-- Form / estado -->
      <ng-container *ngIf="auth.isLoggedIn(); else loginToReview">
        <!-- ✅ si ya tengo review -->
        <div *ngIf="myReview; else canCreate" class="review-form">
          <h3>Tu reseña</h3>

          <div class="my-review-line">
            <strong>Puntuación:</strong> {{ myReview.rating }}/10
          </div>

          <div class="my-review-line">
            <strong>Fecha:</strong> {{ myReview.createdAt | date:'dd/MM/yyyy HH:mm' }}
            <span *ngIf="myReview.edited"> · Editada</span>
          </div>

          <div class="my-review-line" *ngIf="myReview.containsSpoilers">
            ⚠ Contiene spoilers
          </div>

          <p class="review-comment" *ngIf="myReview.comment">{{ myReview.comment }}</p>
          <p class="review-comment" *ngIf="!myReview.comment"><em>Sin comentario.</em></p>

          <!-- luego añadiremos editar/borrar -->
        </div>

        <!-- ✅ puedo crear -->
        <ng-template #canCreate>
          <div class="review-form">
            <h3>Deja tu opinión</h3>

            <label>Puntuación (1-10)</label>
            <input type="number" min="1" max="10" [(ngModel)]="myRating" />

            <label>Comentario</label>
            <textarea rows="3" [(ngModel)]="myComment"></textarea>

            <label class="spoilers">
              <input type="checkbox" [(ngModel)]="mySpoilers" />
              Contiene spoilers
            </label>

            <!-- ✅ arreglado: submitReview() sin argumentos -->
            <button (click)="submitReview()" [disabled]="sendingReview">
              {{ sendingReview ? 'Enviando…' : 'Publicar' }}
            </button>
          </div>
        </ng-template>
      </ng-container>

      <ng-template #loginToReview>
        <p>Inicia sesión para publicar una reseña.</p>
      </ng-template>

      <hr />

      <!-- Listado -->
      <div *ngIf="loadingReviews">Cargando reseñas…</div>

      <div *ngIf="!loadingReviews && !reviews.length">
        <p>Aún no hay reseñas.</p>
      </div>

      <div class="review-list" *ngIf="!loadingReviews && reviews.length">
        <ng-container *ngFor="let r of sortedReviews; let i = index">
          <article class="review-card" [class.review-card--mine]="isMyReview(r)">
            <span class="review-card-badge" *ngIf="isMyReview(r)">Tu reseña</span>
            <div class="review-head">
              <div class="review-score">{{ r.rating }}/10</div>
              <div class="review-meta">
                <div class="review-author">{{ r.displayName }}</div>
                <div class="review-date">{{ r.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
                <span *ngIf="r.edited">Editada</span>
                <span *ngIf="r.containsSpoilers">⚠ Spoilers</span>
              </div>
            </div>
            <p class="review-comment" *ngIf="r.comment">{{ r.comment }}</p>
            <p class="review-comment" *ngIf="!r.comment"><em>Sin comentario.</em></p>
          </article>
          <!-- Separador entre tu reseña y el resto cuando la tuya va primera -->
          <div class="review-list-separator" *ngIf="myReview && i === 0 && sortedReviews.length > 1">
            <hr />
            <p class="review-list-separator-label">Otras opiniones</p>
          </div>
        </ng-container>
      </div>
    </section>
  </div>
</main>

<ng-template #loadingTpl>
  <div class="movie-details-container">Cargando…</div>
</ng-template>